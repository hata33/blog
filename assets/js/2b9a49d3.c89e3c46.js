"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[2479],{7489:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"react/js-to-dom","title":"\u4ece JS \u6587\u4ef6\u5230 DOM \u6e32\u67d3\u7684\u8fc7\u7a0b","description":"1. JS \u6587\u4ef6\u89e3\u6790\u9636\u6bb5","source":"@site/docs/80-react/82-js-to-dom.md","sourceDirName":"80-react","slug":"/react/js-to-dom","permalink":"/blog/docs/react/js-to-dom","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":82,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"React Hooks \u8be6\u89e3","permalink":"/blog/docs/react/hooks"},"next":{"title":"React \u51fd\u6570\u7ec4\u4ef6\u6027\u80fd\u4f18\u5316","permalink":"/blog/docs/react/\u6027\u80fd\u4f18\u5316"}}');var i=t(4848),o=t(8453);const a={},l="\u4ece JS \u6587\u4ef6\u5230 DOM \u6e32\u67d3\u7684\u8fc7\u7a0b",s={},c=[{value:"1. JS \u6587\u4ef6\u89e3\u6790\u9636\u6bb5",id:"1-js-\u6587\u4ef6\u89e3\u6790\u9636\u6bb5",level:2},{value:"1.1 \u8bcd\u6cd5\u5206\u6790",id:"11-\u8bcd\u6cd5\u5206\u6790",level:3},{value:"1.2 \u8bed\u6cd5\u5206\u6790",id:"12-\u8bed\u6cd5\u5206\u6790",level:3},{value:"2. React \u4ee3\u7801\u89e3\u6790",id:"2-react-\u4ee3\u7801\u89e3\u6790",level:2},{value:"2.1 JSX \u8f6c\u6362",id:"21-jsx-\u8f6c\u6362",level:3},{value:"2.2 \u865a\u62df DOM \u521b\u5efa",id:"22-\u865a\u62df-dom-\u521b\u5efa",level:3},{value:"3. React \u6e32\u67d3\u6d41\u7a0b",id:"3-react-\u6e32\u67d3\u6d41\u7a0b",level:2},{value:"3.1 Fiber \u6811\u6784\u5efa",id:"31-fiber-\u6811\u6784\u5efa",level:3},{value:"3.2 \u8c03\u5ea6\u8fc7\u7a0b",id:"32-\u8c03\u5ea6\u8fc7\u7a0b",level:3},{value:"3.3 Reconciliation \u8fc7\u7a0b",id:"33-reconciliation-\u8fc7\u7a0b",level:3},{value:"3.4 Commit \u9636\u6bb5",id:"34-commit-\u9636\u6bb5",level:3},{value:"4. DOM \u64cd\u4f5c",id:"4-dom-\u64cd\u4f5c",level:2},{value:"4.1 \u521b\u5efa DOM \u8282\u70b9",id:"41-\u521b\u5efa-dom-\u8282\u70b9",level:3},{value:"4.2 \u5c5e\u6027\u66f4\u65b0",id:"42-\u5c5e\u6027\u66f4\u65b0",level:3},{value:"4.3 \u4e8b\u4ef6\u7ed1\u5b9a",id:"43-\u4e8b\u4ef6\u7ed1\u5b9a",level:3},{value:"5. \u6027\u80fd\u4f18\u5316",id:"5-\u6027\u80fd\u4f18\u5316",level:2},{value:"5.1 \u6279\u91cf\u66f4\u65b0",id:"51-\u6279\u91cf\u66f4\u65b0",level:3},{value:"5.2 \u65f6\u95f4\u5206\u7247",id:"52-\u65f6\u95f4\u5206\u7247",level:3},{value:"5.3 \u4f18\u5148\u7ea7\u8c03\u5ea6",id:"53-\u4f18\u5148\u7ea7\u8c03\u5ea6",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u4ece-js-\u6587\u4ef6\u5230-dom-\u6e32\u67d3\u7684\u8fc7\u7a0b",children:"\u4ece JS \u6587\u4ef6\u5230 DOM \u6e32\u67d3\u7684\u8fc7\u7a0b"})}),"\n",(0,i.jsx)(n.h2,{id:"1-js-\u6587\u4ef6\u89e3\u6790\u9636\u6bb5",children:"1. JS \u6587\u4ef6\u89e3\u6790\u9636\u6bb5"}),"\n",(0,i.jsx)(n.h3,{id:"11-\u8bcd\u6cd5\u5206\u6790",children:"1.1 \u8bcd\u6cd5\u5206\u6790"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// \u6e90\u4ee3\u7801\nfunction add(a, b) {\n  return a + b;\n}\n\n// \u8bcd\u6cd5\u5206\u6790\u540e\u7684 Token \u6d41\n[\n  { type: 'Keyword', value: 'function' },\n  { type: 'Identifier', value: 'add' },\n  { type: 'Punctuator', value: '(' },\n  { type: 'Identifier', value: 'a' },\n  { type: 'Punctuator', value: ',' },\n  { type: 'Identifier', value: 'b' },\n  { type: 'Punctuator', value: ')' },\n  // ...\n]\n"})}),"\n",(0,i.jsx)(n.h3,{id:"12-\u8bed\u6cd5\u5206\u6790",children:"1.2 \u8bed\u6cd5\u5206\u6790"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'// AST (\u62bd\u8c61\u8bed\u6cd5\u6811) \u793a\u4f8b\n{\n  "type": "Program",\n  "body": [{\n    "type": "FunctionDeclaration",\n    "id": {\n      "type": "Identifier",\n      "name": "add"\n    },\n    "params": [\n      {\n        "type": "Identifier",\n        "name": "a"\n      },\n      {\n        "type": "Identifier",\n        "name": "b"\n      }\n    ],\n    "body": {\n      "type": "BlockStatement",\n      "body": [{\n        "type": "ReturnStatement",\n        "argument": {\n          "type": "BinaryExpression",\n          "operator": "+",\n          "left": { "type": "Identifier", "name": "a" },\n          "right": { "type": "Identifier", "name": "b" }\n        }\n      }]\n    }\n  }]\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"2-react-\u4ee3\u7801\u89e3\u6790",children:"2. React \u4ee3\u7801\u89e3\u6790"}),"\n",(0,i.jsx)(n.h3,{id:"21-jsx-\u8f6c\u6362",children:"2.1 JSX \u8f6c\u6362"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",children:"// JSX \u4ee3\u7801\nfunction App() {\n  return (\n    <div className=\"app\">\n      <h1>Hello</h1>\n    </div>\n  );\n}\n\n// \u8f6c\u6362\u540e\u7684\u4ee3\u7801\nfunction App() {\n  return React.createElement(\n    'div',\n    { className: 'app' },\n    React.createElement('h1', null, 'Hello')\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"22-\u865a\u62df-dom-\u521b\u5efa",children:"2.2 \u865a\u62df DOM \u521b\u5efa"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// \u865a\u62df DOM \u7ed3\u6784\n{\n  type: 'div',\n  props: {\n    className: 'app',\n    children: [{\n      type: 'h1',\n      props: {\n        children: 'Hello'\n      }\n    }]\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"3-react-\u6e32\u67d3\u6d41\u7a0b",children:"3. React \u6e32\u67d3\u6d41\u7a0b"}),"\n",(0,i.jsx)(n.h3,{id:"31-fiber-\u6811\u6784\u5efa",children:"3.1 Fiber \u6811\u6784\u5efa"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// Fiber \u8282\u70b9\u7ed3\u6784\n{\n  type: 'div',\n  key: null,\n  stateNode: HTMLDivElement,\n  child: FiberNode,      // \u7b2c\u4e00\u4e2a\u5b50\u8282\u70b9\n  sibling: FiberNode,    // \u4e0b\u4e00\u4e2a\u5144\u5f1f\u8282\u70b9\n  return: FiberNode,     // \u7236\u8282\u70b9\n  pendingProps: {},      // \u65b0\u7684 props\n  memoizedProps: {},     // \u65e7\u7684 props\n  updateQueue: [],       // \u66f4\u65b0\u961f\u5217\n  memoizedState: {},     // \u72b6\u6001\n  flags: 0,             // \u526f\u4f5c\u7528\u6807\u8bb0\n  alternate: FiberNode   // \u53e6\u4e00\u68f5\u6811\u7684\u5bf9\u5e94\u8282\u70b9\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"32-\u8c03\u5ea6\u8fc7\u7a0b",children:"3.2 \u8c03\u5ea6\u8fc7\u7a0b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// \u4efb\u52a1\u4f18\u5148\u7ea7\u793a\u4f8b\nconst priorities = {\n  ImmediatePriority: 1,    // \u6700\u9ad8\u4f18\u5148\u7ea7\uff0c\u540c\u6b65\n  UserBlockingPriority: 2, // \u7528\u6237\u4ea4\u4e92\n  NormalPriority: 3,       // \u666e\u901a\u4f18\u5148\u7ea7\n  LowPriority: 4,          // \u4f4e\u4f18\u5148\u7ea7\n  IdlePriority: 5          // \u7a7a\u95f2\u4f18\u5148\u7ea7\n};\n\n// \u8c03\u5ea6\u4efb\u52a1\nfunction scheduleCallback(priority, callback) {\n  const currentTime = getCurrentTime();\n  const timeout = computeTimeout(priority);\n  const expirationTime = currentTime + timeout;\n  \n  const newTask = {\n    callback,\n    priority,\n    expirationTime,\n    next: null\n  };\n  \n  // \u52a0\u5165\u4efb\u52a1\u961f\u5217\n  enqueueTask(newTask);\n  // \u5f00\u59cb\u8c03\u5ea6\n  requestHostCallback(flushWork);\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"33-reconciliation-\u8fc7\u7a0b",children:"3.3 Reconciliation \u8fc7\u7a0b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function reconcileChildFibers(returnFiber, currentFirstChild, newChild) {\n  // \u5355\u4e2a\u5143\u7d20\n  if (typeof newChild === 'object' && newChild !== null) {\n    switch (newChild.$$typeof) {\n      case REACT_ELEMENT_TYPE:\n        return placeSingleChild(\n          reconcileSingleElement(\n            returnFiber,\n            currentFirstChild,\n            newChild\n          )\n        );\n    }\n  }\n  \n  // \u591a\u4e2a\u5b50\u5143\u7d20\n  if (Array.isArray(newChild)) {\n    return reconcileChildrenArray(\n      returnFiber,\n      currentFirstChild,\n      newChild\n    );\n  }\n  \n  // \u6587\u672c\u8282\u70b9\n  if (typeof newChild === 'string' || typeof newChild === 'number') {\n    return reconcileSingleTextNode(\n      returnFiber,\n      currentFirstChild,\n      '' + newChild\n    );\n  }\n  \n  // \u5220\u9664\u65e7\u8282\u70b9\n  return deleteRemainingChildren(returnFiber, currentFirstChild);\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"34-commit-\u9636\u6bb5",children:"3.4 Commit \u9636\u6bb5"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function commitRoot(root) {\n  const finishedWork = root.finishedWork;\n  \n  // \u63d0\u4ea4\u524d\u7684\u51c6\u5907\u5de5\u4f5c\n  prepareForCommit(root.containerInfo);\n  \n  // \u63d0\u4ea4\u6240\u6709\u526f\u4f5c\u7528\n  let firstEffect;\n  if (finishedWork.flags > PerformedWork) {\n    if (finishedWork.lastEffect !== null) {\n      finishedWork.lastEffect.nextEffect = finishedWork;\n      firstEffect = finishedWork.firstEffect;\n    } else {\n      firstEffect = finishedWork;\n    }\n  } else {\n    firstEffect = finishedWork.firstEffect;\n  }\n  \n  // \u4e09\u4e2a\u9636\u6bb5\u7684\u63d0\u4ea4\n  // 1. before mutation\n  commitBeforeMutationEffects(firstEffect);\n  \n  // 2. mutation\n  commitMutationEffects(root, firstEffect);\n  \n  // 3. layout\n  root.current = finishedWork;\n  commitLayoutEffects(firstEffect, root);\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"4-dom-\u64cd\u4f5c",children:"4. DOM \u64cd\u4f5c"}),"\n",(0,i.jsx)(n.h3,{id:"41-\u521b\u5efa-dom-\u8282\u70b9",children:"4.1 \u521b\u5efa DOM \u8282\u70b9"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function createInstance(type, props, rootContainerInstance) {\n  const domElement = document.createElement(type);\n  precacheFiberNode(domElement);\n  updateFiberProps(domElement, props);\n  return domElement;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"42-\u5c5e\u6027\u66f4\u65b0",children:"4.2 \u5c5e\u6027\u66f4\u65b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function updateDOMProperties(domElement, updatePayload) {\n  for (let i = 0; i < updatePayload.length; i += 2) {\n    const propKey = updatePayload[i];\n    const propValue = updatePayload[i + 1];\n    \n    if (propKey === STYLE) {\n      updateStyles(domElement, propValue);\n    } else if (propKey === CHILDREN) {\n      setTextContent(domElement, propValue);\n    } else {\n      setProp(domElement, propKey, propValue);\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"43-\u4e8b\u4ef6\u7ed1\u5b9a",children:"4.3 \u4e8b\u4ef6\u7ed1\u5b9a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function listenToNativeEvent(\n  domEventName,\n  isCapturePhaseListener,\n  target\n) {\n  let eventSystemFlags = 0;\n  if (isCapturePhaseListener) {\n    eventSystemFlags |= IS_CAPTURE_PHASE;\n  }\n  addTrappedEventListener(\n    target,\n    domEventName,\n    eventSystemFlags,\n    isCapturePhaseListener\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"5-\u6027\u80fd\u4f18\u5316",children:"5. \u6027\u80fd\u4f18\u5316"}),"\n",(0,i.jsx)(n.h3,{id:"51-\u6279\u91cf\u66f4\u65b0",children:"5.1 \u6279\u91cf\u66f4\u65b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function batchedUpdates(fn) {\n  const previousIsBatchingUpdates = isBatchingUpdates;\n  isBatchingUpdates = true;\n  try {\n    return fn();\n  } finally {\n    isBatchingUpdates = previousIsBatchingUpdates;\n    if (!isBatchingUpdates && !isRendering) {\n      performSyncWork();\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"52-\u65f6\u95f4\u5206\u7247",children:"5.2 \u65f6\u95f4\u5206\u7247"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    workInProgress = performUnitOfWork(workInProgress);\n  }\n}\n\nfunction shouldYield() {\n  const currentTime = getCurrentTime();\n  return currentTime >= deadline;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"53-\u4f18\u5148\u7ea7\u8c03\u5ea6",children:"5.3 \u4f18\u5148\u7ea7\u8c03\u5ea6"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"function ensureRootIsScheduled(root) {\n  const nextLanes = getNextLanes(\n    root,\n    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes\n  );\n  \n  if (nextLanes === NoLanes) {\n    return;\n  }\n  \n  const schedulerPriority = lanesToSchedulerPriority(nextLanes);\n  \n  const newCallbackNode = scheduleCallback(\n    schedulerPriority,\n    performConcurrentWorkOnRoot.bind(null, root)\n  );\n  \n  root.callbackNode = newCallbackNode;\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>l});var r=t(6540);const i={},o=r.createContext(i);function a(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);