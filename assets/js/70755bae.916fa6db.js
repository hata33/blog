"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[901],{8596:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>g,frontMatter:()=>l,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"canvas/\u56fe\u7247\u5904\u7406","title":"Canvas \u56fe\u7247\u5904\u7406","description":"1. \u56fe\u7247\u538b\u7f29","source":"@site/docs/71-canvas/02-\u56fe\u7247\u5904\u7406.mdx","sourceDirName":"71-canvas","slug":"/canvas/\u56fe\u7247\u5904\u7406","permalink":"/blog/docs/canvas/\u56fe\u7247\u5904\u7406","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"\u7b97\u6cd5","permalink":"/blog/docs/\u7b97\u6cd5/\u7b97\u6cd5"},"next":{"title":"React JSX \u5230\u771f\u5b9e DOM \u7684\u6e32\u67d3\u8fc7\u7a0b","permalink":"/blog/docs/react/jsx-to-html"}}');var s=a(4848),i=a(8453),r=a(6540);const c=e=>{let{maxWidth:n=800,maxHeight:a=600,quality:t=.8}=e;const[i,c]=(0,r.useState)(""),[l,d]=(0,r.useState)(0),[o,h]=(0,r.useState)(0),m=(0,r.useRef)(null);return(0,s.jsxs)("div",{children:[(0,s.jsx)("input",{type:"file",accept:"image/*",onChange:async e=>{const s=e.target.files?.[0];if(s){d(s.size);try{const e=await(e=>new Promise((s=>{const i=new Image;i.src=URL.createObjectURL(e),i.onload=()=>{const e=m.current,r=e.getContext("2d");let c=i.width,l=i.height;c>n&&(l=n*l/c,c=n),l>a&&(c=a*c/l,l=a),e.width=c,e.height=l,r.drawImage(i,0,0,c,l),e.toBlob((e=>s(e)),"image/jpeg",t),URL.revokeObjectURL(i.src)}})))(s);h(e.size),c(URL.createObjectURL(e))}catch(i){console.error("\u538b\u7f29\u5931\u8d25:",i)}}}}),(0,s.jsx)("canvas",{ref:m,style:{display:"none"}}),i&&(0,s.jsxs)("div",{children:[(0,s.jsx)("img",{src:i,alt:"\u538b\u7f29\u9884\u89c8",style:{maxWidth:"100%"}}),(0,s.jsxs)("div",{children:["\u539f\u59cb\u5927\u5c0f: ",(l/1024).toFixed(2)," KB",(0,s.jsx)("br",{}),"\u538b\u7f29\u540e\u5927\u5c0f: ",(o/1024).toFixed(2)," KB",(0,s.jsx)("br",{}),"\u538b\u7f29\u7387: ",(100*(1-o/l)).toFixed(2),"%"]})]})]})},l={},d="Canvas \u56fe\u7247\u5904\u7406",o={},h=[{value:"1. \u56fe\u7247\u538b\u7f29",id:"1-\u56fe\u7247\u538b\u7f29",level:2},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406",level:3},{value:"2. \u5176\u4ed6\u56fe\u7247\u5904\u7406\u529f\u80fd",id:"2-\u5176\u4ed6\u56fe\u7247\u5904\u7406\u529f\u80fd",level:2},{value:"\u6ee4\u955c\u6548\u679c",id:"\u6ee4\u955c\u6548\u679c",level:3},{value:"\u50cf\u7d20\u64cd\u4f5c",id:"\u50cf\u7d20\u64cd\u4f5c",level:3},{value:"\u56fe\u7247\u88c1\u526a",id:"\u56fe\u7247\u88c1\u526a",level:3},{value:"3. \u6027\u80fd\u4f18\u5316",id:"3-\u6027\u80fd\u4f18\u5316",level:2},{value:"1. \u7f13\u5b58 Canvas",id:"1-\u7f13\u5b58-canvas",level:3},{value:"2. \u4f7f\u7528 requestAnimationFrame",id:"2-\u4f7f\u7528-requestanimationframe",level:3},{value:"3. \u4f7f\u7528 Web Workers",id:"3-\u4f7f\u7528-web-workers",level:3}];function m(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"canvas-\u56fe\u7247\u5904\u7406",children:"Canvas \u56fe\u7247\u5904\u7406"})}),"\n",(0,s.jsx)(n.h2,{id:"1-\u56fe\u7247\u538b\u7f29",children:"1. \u56fe\u7247\u538b\u7f29"}),"\n",(0,s.jsx)(n.p,{children:"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u4f7f\u7528 Canvas \u5b9e\u73b0\u7684\u56fe\u7247\u538b\u7f29\u793a\u4f8b\uff1a"}),"\n",(0,s.jsx)(c,{}),"\n",(0,s.jsx)(n.h3,{id:"\u5b9e\u73b0\u539f\u7406",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528 Canvas \u8c03\u6574\u56fe\u7247\u5c3a\u5bf8"}),"\n",(0,s.jsx)(n.li,{children:"\u901a\u8fc7 quality \u53c2\u6570\u63a7\u5236\u538b\u7f29\u8d28\u91cf"}),"\n",(0,s.jsx)(n.li,{children:"\u8f6c\u6362\u4e3a Blob \u5bf9\u8c61\u8f93\u51fa"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"const compressImage = (file: File): Promise<Blob> => {\n  return new Promise((resolve) => {\n    const img = new Image();\n    img.src = URL.createObjectURL(file);\n    \n    img.onload = () => {\n      const canvas = document.createElement('canvas');\n      const ctx = canvas.getContext('2d')!;\n\n      // \u8ba1\u7b97\u7f29\u653e\u6bd4\u4f8b\n      let width = img.width;\n      let height = img.height;\n      \n      if (width > maxWidth) {\n        height = (maxWidth * height) / width;\n        width = maxWidth;\n      }\n\n      // \u8bbe\u7f6e canvas \u5c3a\u5bf8\n      canvas.width = width;\n      canvas.height = height;\n\n      // \u7ed8\u5236\u56fe\u7247\n      ctx.drawImage(img, 0, 0, width, height);\n\n      // \u8f6c\u6362\u4e3a blob\n      canvas.toBlob(\n        (blob) => resolve(blob!),\n        'image/jpeg',\n        quality\n      );\n    };\n  });\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"2-\u5176\u4ed6\u56fe\u7247\u5904\u7406\u529f\u80fd",children:"2. \u5176\u4ed6\u56fe\u7247\u5904\u7406\u529f\u80fd"}),"\n",(0,s.jsx)(n.h3,{id:"\u6ee4\u955c\u6548\u679c",children:"\u6ee4\u955c\u6548\u679c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// \u7070\u5ea6\u6ee4\u955c\nctx.filter = 'grayscale(100%)';\nctx.drawImage(img, 0, 0);\n\n// \u6a21\u7cca\u6ee4\u955c\nctx.filter = 'blur(5px)';\nctx.drawImage(img, 0, 0);\n\n// \u4eae\u5ea6\u8c03\u6574\nctx.filter = 'brightness(150%)';\nctx.drawImage(img, 0, 0);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u50cf\u7d20\u64cd\u4f5c",children:"\u50cf\u7d20\u64cd\u4f5c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// \u83b7\u53d6\u50cf\u7d20\u6570\u636e\nconst imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\nconst data = imageData.data;\n\n// \u4fee\u6539\u50cf\u7d20\nfor (let i = 0; i < data.length; i += 4) {\n  // \u53cd\u8f6c\u989c\u8272\n  data[i] = 255 - data[i];         // red\n  data[i + 1] = 255 - data[i + 1]; // green\n  data[i + 2] = 255 - data[i + 2]; // blue\n  // data[i + 3] \u662f alpha \u901a\u9053\n}\n\n// \u5c06\u4fee\u6539\u540e\u7684\u50cf\u7d20\u6570\u636e\u653e\u56de canvas\nctx.putImageData(imageData, 0, 0);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u56fe\u7247\u88c1\u526a",children:"\u56fe\u7247\u88c1\u526a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"const cropImage = (x: number, y: number, width: number, height: number) => {\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d')!;\n  \n  canvas.width = width;\n  canvas.height = height;\n  \n  // \u7ed8\u5236\u88c1\u526a\u533a\u57df\n  ctx.drawImage(\n    sourceCanvas, \n    x, y, width, height,  // \u6e90\u56fe\u50cf\u88c1\u526a\u533a\u57df\n    0, 0, width, height   // \u76ee\u6807\u533a\u57df\n  );\n  \n  return canvas;\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"3-\u6027\u80fd\u4f18\u5316",children:"3. \u6027\u80fd\u4f18\u5316"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u7f13\u5b58-canvas",children:"1. \u7f13\u5b58 Canvas"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// \u521b\u5efa\u79bb\u5c4f canvas\nconst offscreenCanvas = document.createElement('canvas');\nconst offscreenCtx = offscreenCanvas.getContext('2d');\n\n// \u5728\u79bb\u5c4f canvas \u4e2d\u5904\u7406\u56fe\u7247\noffscreenCtx.drawImage(img, 0, 0);\n\n// \u6700\u540e\u4e00\u6b21\u6027\u7ed8\u5236\u5230\u663e\u793a canvas\ndisplayCtx.drawImage(offscreenCanvas, 0, 0);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-\u4f7f\u7528-requestanimationframe",children:"2. \u4f7f\u7528 requestAnimationFrame"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"const animate = () => {\n  // \u5904\u7406\u56fe\u7247\n  processImage();\n  \n  // \u4e0b\u4e00\u5e27\u7ee7\u7eed\n  requestAnimationFrame(animate);\n};\n\nrequestAnimationFrame(animate);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-\u4f7f\u7528-web-workers",children:"3. \u4f7f\u7528 Web Workers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// \u521b\u5efa Worker\nconst worker = new Worker('imageProcessor.js');\n\n// \u53d1\u9001\u6570\u636e\u7ed9 Worker\nworker.postMessage({\n  imageData: ctx.getImageData(0, 0, width, height),\n  params: { brightness: 1.2, contrast: 1.1 }\n});\n\n// \u63a5\u6536\u5904\u7406\u7ed3\u679c\nworker.onmessage = (e) => {\n  ctx.putImageData(e.data, 0, 0);\n};\n"})})]})}function g(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(m,{...e})}):m(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>c});var t=a(6540);const s={},i=t.createContext(s);function r(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);